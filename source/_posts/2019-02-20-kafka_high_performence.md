---
title: kafka 高性能原理
date: 2019-02-20 15:00
category: 后端
tags: [kafka, 消息队列]
---

# 摘要

kafka 作为消息分布式发布-订阅系统，吞吐量很高，在峰值每秒会发布超过百万条消息，而且还能够持久化存储。

作为消息队列，要承接读跟写两块的功能，首先要将消息日志写入 kafka.

# kafka 在读写上的优化

## 写

kafka 维护一个 topic 中的分区 log, 以顺序追加的方式向各个分区中写入消息，每个分区都是不变的消息队列。分区中的消息都是以 k - v 形式存在

- k offset, 成为；偏移量，一个 64 位整型的唯一标识，offset 代表了 topic 分区中所有消息流中该消息的起始字节位置
- v 消息内容，每个分区中的每个 offset 唯一存在，所有分区的消息都是一次性写入，在消息未过期前都可以调整 offset 多次读取

kafka 在将消息写入磁盘时全是顺序写操作，目前大部分磁盘还是机械结构，顺序写要比随机写的效率高很多，避免了大量缓慢的机械运动。
过于频繁的小 I/O 操作会拖慢速度，所以 kafka 会将一批次消息打包到一起批量写回磁盘。

### MMAP

kafka 使用了 MMAP(Memory Mapped Files, 内存映射文件)技术。将主存作为磁盘缓存，当内存回收时几乎没有性能损失。

### 零拷贝

当需要网络传输日志时，比如传输持久性日志块，常规的接口从传输需要四次拷贝。
在使用 MMAP 时，可以使用 Linux 提供的传输接口 `sendfile` 系统调用，直接从页缓存复制到 socket 中进行网络传输。

~~真是，先这样吧~~